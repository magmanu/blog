"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[6517],{8118:(e,a,o)=>{o.r(a),o.d(a,{assets:()=>c,contentTitle:()=>t,default:()=>u,frontMatter:()=>i,metadata:()=>r,toc:()=>d});var n=o(4848),s=o(8453);const i={slug:"github-actions-data-flow",title:"GitHub Actions: Fluxo e Persist\xeancia de Dados em Workflows",authors:"manu",tags:["github actions","ci/cd","pipeline","env","outputs","artefatos","cache"]},t=void 0,r={permalink:"/blog/pt-BR/tech/github-actions-data-flow",source:"@site/i18n/pt-BR/docusaurus-plugin-content-blog-tech/2023-10-31-github-actions-data-flow/index.md",title:"GitHub Actions: Fluxo e Persist\xeancia de Dados em Workflows",description:"Quando se trata de Github Actions, os dados n\xe3o s\xe3o persistentes por natureza, nem ficam dispon\xedveis para todo o pipeline. Cada etapa (step) tem seu pr\xf3prio processo, cada trabalho (job) tem seu pr\xf3prio executor (runner). Por padr\xe3o, quaisquer dados que surjam em um trabalho terminam com ele.",date:"2023-10-31T00:00:00.000Z",tags:[{label:"github actions",permalink:"/blog/pt-BR/tech/tags/github-actions"},{label:"ci/cd",permalink:"/blog/pt-BR/tech/tags/ci-cd"},{label:"pipeline",permalink:"/blog/pt-BR/tech/tags/pipeline"},{label:"env",permalink:"/blog/pt-BR/tech/tags/env"},{label:"outputs",permalink:"/blog/pt-BR/tech/tags/outputs"},{label:"artefatos",permalink:"/blog/pt-BR/tech/tags/artefatos"},{label:"cache",permalink:"/blog/pt-BR/tech/tags/cache"}],readingTime:11.565,hasTruncateMarker:!0,authors:[{name:"Manu Magalh\xe3es",title:"Engenheira de DevSecOps",url:"https://github.com/magmanu",imageURL:"https://github.com/magmanu.png",key:"manu"}],frontMatter:{slug:"github-actions-data-flow",title:"GitHub Actions: Fluxo e Persist\xeancia de Dados em Workflows",authors:"manu",tags:["github actions","ci/cd","pipeline","env","outputs","artefatos","cache"]},unlisted:!1,nextItem:{title:"Como Gerar JSON Din\xe2mico no Terraform",permalink:"/blog/pt-BR/tech/dynamic-json-in-terraform"}},c={authorsImageUrls:[void 0]},d=[{value:"Como usar <code>env</code>",id:"como-usar-env",level:2},{value:"Dica de debug",id:"dica-de-debug",level:4},{value:"Como usar <code>outputs</code>",id:"como-usar-outputs",level:2},{value:"Como usar  artefatos",id:"como-usar--artefatos",level:2},{value:"Subir artefatos",id:"subir-artefatos",level:3},{value:"Baixar artefatos",id:"baixar-artefatos",level:3},{value:"Apagar artefatos",id:"apagar-artefatos",level:3},{value:"Como usar cache",id:"como-usar-cache",level:2},{value:"Using cache",id:"using-cache",level:2},{value:"Configurando o cache",id:"configurando-o-cache",level:3},{value:"Recuperando o cache",id:"recuperando-o-cache",level:3},{value:"Atualizando o cache",id:"atualizando-o-cache",level:3},{value:"Coment\xe1rios finais sobre caches",id:"coment\xe1rios-finais-sobre-caches",level:3}];function l(e){const a={a:"a",admonition:"admonition",br:"br",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components},{Details:o}=a;return o||function(e,a){throw new Error("Expected "+(a?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(a.p,{children:"Quando se trata de Github Actions, os dados n\xe3o s\xe3o persistentes por natureza, nem ficam dispon\xedveis para todo o pipeline. Cada etapa (step) tem seu pr\xf3prio processo, cada trabalho (job) tem seu pr\xf3prio executor (runner). Por padr\xe3o, quaisquer dados que surjam em um trabalho terminam com ele."}),"\n",(0,n.jsx)(a.p,{children:"Ent\xe3o, como podemos passar dados de um processo para outro, ou salvar dados para uma execu\xe7\xe3o futura?"}),"\n",(0,n.jsx)(a.p,{children:"A resposta r\xe1pida e certeira \xe9 essa:"}),"\n",(0,n.jsxs)(a.table,{children:[(0,n.jsx)(a.thead,{children:(0,n.jsxs)(a.tr,{children:[(0,n.jsx)(a.th,{children:"Estrat\xe9gia"}),(0,n.jsx)(a.th,{children:"Dados"}),(0,n.jsx)(a.th,{children:"Escopo"}),(0,n.jsx)(a.th,{children:"Persist\xeancia"}),(0,n.jsx)(a.th,{children:"Detalhes"}),(0,n.jsx)(a.th,{children:"Exemplo"})]})}),(0,n.jsxs)(a.tbody,{children:[(0,n.jsxs)(a.tr,{children:[(0,n.jsx)(a.td,{children:(0,n.jsx)(a.code,{children:"env"})}),(0,n.jsx)(a.td,{children:"Valores"}),(0,n.jsx)(a.td,{children:"Trabalho (interno)"}),(0,n.jsx)(a.td,{children:"Ef\xeamero"}),(0,n.jsxs)(a.td,{children:["Propaga ",(0,n.jsx)(a.em,{children:"dados"})," ",(0,n.jsx)("br",{})," entre ",(0,n.jsx)(a.em,{children:"etapas"})," ",(0,n.jsx)("br",{})," no mesmo ",(0,n.jsx)(a.em,{children:"trabalho"})]}),(0,n.jsx)(a.td,{children:"Passar um booleano para determinar se a pr\xf3xima estapa deve ser executada"})]}),(0,n.jsxs)(a.tr,{children:[(0,n.jsx)(a.td,{children:(0,n.jsx)(a.code,{children:"outputs"})}),(0,n.jsx)(a.td,{children:"Valores"}),(0,n.jsx)(a.td,{children:"Fluxo de trabalho (interno)"}),(0,n.jsx)(a.td,{children:"Ef\xeamero"}),(0,n.jsxs)(a.td,{children:["Propaga ",(0,n.jsx)(a.em,{children:"dados"})," ",(0,n.jsx)("br",{})," entre ",(0,n.jsx)(a.em,{children:"trabalhos/etapas"})," ",(0,n.jsx)("br",{})," no mesmo ",(0,n.jsx)(a.em,{children:"fluxo de trabalho"})]}),(0,n.jsx)(a.td,{children:"Passar um ID  para o pr\xf3ximo trabalho"})]}),(0,n.jsxs)(a.tr,{children:[(0,n.jsx)(a.td,{children:"artefatos"}),(0,n.jsx)(a.td,{children:"Arquivos"}),(0,n.jsx)(a.td,{children:"Fluxo de trabalho (interno e externo)"}),(0,n.jsx)(a.td,{children:"Persistente"}),(0,n.jsxs)(a.td,{children:["Propaga ",(0,n.jsx)(a.em,{children:"arquivos"})," ",(0,n.jsx)("br",{})," entre ",(0,n.jsx)(a.em,{children:"trabalhos/fluxos de trabalho"})]}),(0,n.jsxs)(a.td,{children:["Passar o build de um projeto para diferentes trabalhos de teste executados em paralelo ",(0,n.jsx)("br",{}),(0,n.jsx)("br",{})," ",(0,n.jsx)(a.em,{children:"Prefer\xeancia a dados que mudam frequentemente. Os arquivos ficam dispon\xedveis para download ap\xf3s o t\xe9rmino do fluxo de trabalho."})]})]}),(0,n.jsxs)(a.tr,{children:[(0,n.jsx)(a.td,{children:"cache"}),(0,n.jsx)(a.td,{children:"Arquivos"}),(0,n.jsx)(a.td,{children:"Fluxo de trabalho (interno e externo)"}),(0,n.jsx)(a.td,{children:"Persistente"}),(0,n.jsxs)(a.td,{children:["Propaga ",(0,n.jsx)(a.em,{children:"arquivos"})," ",(0,n.jsx)("br",{})," dentro e entre ",(0,n.jsx)(a.em,{children:"fluxos de trabalho"})," ",(0,n.jsx)("br",{})," no mesmo ",(0,n.jsx)(a.em,{children:"reposit\xf3rio"})]}),(0,n.jsxs)(a.td,{children:["Armazenar pacotes npm em cache para uso em diferentes execu\xe7\xf5es de fluxo de trabalho. ",(0,n.jsx)("br",{}),(0,n.jsx)("br",{})," ",(0,n.jsx)(a.em,{children:"Destinado a arquivos que n\xe3o mudam muito."})]})]})]})]}),"\n",(0,n.jsxs)(a.p,{children:["Para uma resposta mais completa, continue lendo.\nTodos os exemplos de fluxo de trabalho neste artigo \u200b\u200b",(0,n.jsx)(a.a,{href:"https://github.com/magmanu/blog/tree/main/demos/github-actions-data-flow",children:"est\xe3o disponiveis em formato de arquivo aqui"}),", junto com uma c\xf3pia dos respectivos logs editados (em ingl\xeas)."]}),"\n",(0,n.jsxs)(a.h2,{id:"como-usar-env",children:["Como usar ",(0,n.jsx)(a.code,{children:"env"})]}),"\n",(0,n.jsxs)(a.p,{children:["\xc9 muito simples transferir dados entre etapas: defina um par chave-valor (key/value) e grave-o no arquivo de ambiente ",(0,n.jsx)(a.code,{children:"GITHUB_ENV"}),", usando a sintaxe apropriada para seu shell. Veja exemplos abaixo em bash e python:"]}),"\n",(0,n.jsxs)(o,{children:[(0,n.jsx)("summary",{children:(0,n.jsx)(a.p,{children:"Exibir c\xf3digo"})}),(0,n.jsx)("div",{children:(0,n.jsx)(a.pre,{children:(0,n.jsx)(a.code,{className:"language-yaml",metastring:'title="/.github/workflows/using_env.yaml"',children:'    steps:\n      - name: Duas formas de definir vari\xe1veis de ambiente\n      # Aviso: nesta etapa, o input n\xe3o foi sanitizado nem validado\n        shell: bash\n        run: |\n          # N\xe3o exibe a vari\xe1vel nos logs.\n          wikipedia_aleatorio_1=$(curl -L -X GET "https://en.wikipedia.org/api/rest_v1/page/random/summary" | jq .title)\n          echo "$wikipedia_aleatorio_1"\n          echo "ARTIGO_1=$wikipedia_aleatorio_1" >> "$GITHUB_ENV"\n          # \ud83d\udc09 Exibe a vari\xe1vel nos logs: use apenas com dados que n\xe3o sejam confidenciais!\n          wikipedia_aleatorio_2=$(curl -L -X GET "https://en.wikipedia.org/api/rest_v1/page/random/summary" | jq .title)\n          echo "ARTIGO_2=$wikipedia_aleatorio_2" | tee -a "$GITHUB_ENV"\n\n      - name: Definir vari\xe1veis de ambiente em python\n        shell: python\n        # se usar "write", use \\n ao criar mais de uma vari\xe1vel\n        # com "print", \\n n\xe3o \xe9 necess\xe1rio\n        run: |\n          from os import environ as env\n          with open(env.get(\'GITHUB_ENV\', None), \'a\') as ghenv:\n            ghenv.write("SUJEITO=Sun\\n")\n            print("ESTADO=radiant", file=ghenv)\n            print("DIA=today", file=ghenv)\n          \n      - name: \ud83d\udee1\ufe0f Recuperando valores de forma segura\n        # observe que ARTIGO_1 n\xe3o foi sanitizado ou validado, por isso, est\xe1 vulner\xe1vel a ataques de inje\xe7\xe3o.\n        # A abordagem abaixo evita o problema ao passar ARTIGO_1 como argumento para o script.\n        # Tamb\xe9m \xe9 poss\xedvel renamear as vari\xe1veis\n        env:\n          QUEM: ${{ env.SUJEITO }}\n          QUE: ${{ env.ARTIGO_1 }}\n          QUANDO: ${{ env.DIA }}\n        run: |\n          echo "$QUEM leu sobre $QUE $QUANDO."\n        \n      - name: \ud83d\udc09 Recuperando valores de forma potencialmente vulner\xe1vel\n        # Esta abordagem \xe9 vulner\xe1vel a ataques de inje\xe7\xe3o!\n        # Use apenas se voc\xea tiver controle sobre o input\n        shell: bash\n        run: |\n          echo "${{ env.SUJEITO }} est\xe1 ${{ env.ESTADO }} ${{ env.DIA }}."\n'})})})]}),"\n",(0,n.jsx)(a.h4,{id:"dica-de-debug",children:"Dica de debug"}),"\n",(0,n.jsx)(a.p,{children:"Para listar todas as vari\xe1veis \u200b\u200bde ambiente dispon\xedveis em um trabalho, adicione esta pequena etapa:"}),"\n",(0,n.jsx)(a.p,{children:(0,n.jsx)(a.code,{children:"- run: env"})}),"\n",(0,n.jsxs)(a.h2,{id:"como-usar-outputs",children:["Como usar ",(0,n.jsx)(a.code,{children:"outputs"})]}),"\n",(0,n.jsxs)(a.p,{children:["Os outputs ficam dispon\xedveis para todas as etapas do mesmo trabalho e para qualquer trabalho subsequente que precise deles.\nOutputs sempre s\xe3o ",(0,n.jsx)(a.strong,{children:"strings"})," unicode."]}),"\n",(0,n.jsxs)(a.p,{children:["E obviamente, trabalhos que dependem de um ",(0,n.jsx)(a.code,{children:"output"})," n\xe3o ser\xe3o executados em paralelo com o trabalho que produz o output."]}),"\n",(0,n.jsxs)(o,{children:[(0,n.jsx)("summary",{children:(0,n.jsx)(a.p,{children:"Mostrar c\xf3digo"})}),(0,n.jsxs)("div",{children:[(0,n.jsx)(a.p,{children:"Para simplificar, o output foi definido em bash, mas voc\xea pode usar o shell que preferir."}),(0,n.jsx)(a.pre,{children:(0,n.jsx)(a.code,{className:"language-yaml",metastring:'title="/.github/workflows/outputs-for-different-job.yaml"',children:'jobs:\n  definicao-de-output:\n    runs-on: ubuntu-latest\n    // highlight-start\n    outputs:  # Obrigat\xf3rio: defina o output no trabalho para que fique dispon\xedvel a outros trabalhos\n      nome: ${{ steps.valor-estatico.outputs.NOME }}\n      lugar: ${{ steps.valor-dinamico.outputs.LUGAR }}\n    // highlight-end\n    steps:\n      - id: valor-estatico\n        run: |\n          // highlight-next-line\n          echo "NOME=Marcela" >> "$GITHUB_OUTPUT"\n      \n      - id: valor-dinamico\n        # Observe o use de jq -c para obter o valor como uma \xfanica linha\n        run: |\n          lugar=$(curl -H "Accept: application/json" https://randomuser.me/api/ | jq -c .results[].lugar)\n          // highlight-next-line\n          echo "LUGAR=$lugar" > "$GITHUB_OUTPUT"\n\n  recuperacao-de--outputs:\n    runs-on: ubuntu-latest\n    needs: definicao-de-output\n    steps:\n      - name: boas-vindas\n        run: |\n          PAIS=$(echo $GEODATA | jq -r . | jq .PAIS)\n          echo "Ol\xe1 $nome! $PAIS \xe9/s\xe3o um lindo pa\xeds, divirta-se!"\n         // highlight-start\n        env:\n          name: ${{needs.definicao-de-output.outputs.nome}}\n          GEODATA: ${{ needs.definicao-de-output.outputs.lugar }}\n        // highlight-end\n'})})]})]}),"\n",(0,n.jsxs)(a.p,{children:["Embora seja recomendado usar ",(0,n.jsx)(a.code,{children:"env"})," para passar dados entre etapas, ",(0,n.jsx)(a.code,{children:"outputs"})," tamb\xe9m pode ser usado. Isso \xe9 \xfatil quando um valor \xe9 necess\xe1rio tanto no trabalho atual quanto nos trabalhos a seguir."]}),"\n",(0,n.jsxs)(o,{children:[(0,n.jsx)("summary",{children:(0,n.jsx)(a.p,{children:"Mostrar c\xf3digo"})}),(0,n.jsxs)("div",{children:[(0,n.jsx)(a.p,{children:"O exemplo anterior mostrou como usar outputs em diferentes trabalhos.\nPara usar um output no trabalho em que ele \xe9 definido, basta adicionar o c\xf3digo em destaque abaixo."}),(0,n.jsx)(a.pre,{children:(0,n.jsx)(a.code,{className:"language-yaml",metastring:'title="/.github/workflows/outputs-for-same-job.yaml"',children:'jobs:\n  definicao-de-output:\n    runs-on: ubuntu-latest\n    outputs:\n      name: ${{ steps.valor-estatico.outputs.NOME }}\n      lugar: ${{ steps.valor-dinamico.outputs.LUGAR }}\n    steps:\n      - id: valor-estatico\n        run: |\n          echo "NOME=Marcela" >> "$GITHUB_OUTPUT"\n      // highlight-start\n      - name: Consumir o output no mesmo trabalho\n        run: |\n          echo "$NOME, $GEODATA \xe9 sua localiza\xe7\xe3o. Atualizamos seu fuso hor\xe1rio para GMT$OFFSET."\n        env:\n          NOME: ${{ steps.valor-estatico.outputs.NOME }}\n          # Use fromJSON() direto no env ao filtrar o valor do output ainda no env\n          # Veja mais sobre filtragem de objetos em  \n          # https://docs.github.com/en/actions/learn-github-actions/expressions#object-filters\n          GEODATA: ${{ fromJSON(steps.valor-dinamico.outputs.LUGAR).country }}\n          OFFSET: ${{ fromJSON(steps.valor-dinamico.outputs.LUGAR).timezone.offset }}\n      // highlight-end\n\n    (...)\n'})})]})]}),"\n",(0,n.jsx)(a.admonition,{title:"Dica de debug",type:"info",children:(0,n.jsxs)(a.ul,{children:["\n",(0,n.jsx)(a.li,{children:"Um output individual deve ter no m\xe1ximo 1 MB."}),"\n",(0,n.jsx)(a.li,{children:"Todos os outputs combinados n\xe3o devem exceder 50MB."}),"\n"]})}),"\n",(0,n.jsx)("br",{}),"\n",(0,n.jsxs)(a.admonition,{title:"XP da vida Real",type:"tip",children:[(0,n.jsxs)(a.p,{children:[(0,n.jsx)(a.code,{children:"GITHUB_OUTPUT"})," espera uma string de apenas uma linha.\nSe precisar de um output com v\xe1rias linhas, atribua-as a uma vari\xe1vel e construa o output assim:"]}),(0,n.jsx)(a.pre,{children:(0,n.jsx)(a.code,{className:"language-bash",children:'echo "NOME_DO_PAYLOAD<<EOF"$\'\\n\'"$valor_do_payload"$\'\\n\'EOF >> "$GITHUB_OUTPUT".\n'})})]}),"\n",(0,n.jsx)(a.h2,{id:"como-usar--artefatos",children:"Como usar  artefatos"}),"\n",(0,n.jsxs)(a.p,{children:["A documenta\xe7\xe3o diz: ",(0,n.jsx)(a.em,{children:"Use artefatos quando desejar salvar arquivos produzidos por um trabalho para visualiza\xe7\xe3o ap\xf3s o t\xe9rmino da execu\xe7\xe3o do fluxo de trabalho, como bin\xe1rios compilados ou logs de compila\xe7\xe3o"}),". (tradu\xe7\xe3o livre)"]}),"\n",(0,n.jsx)(a.h3,{id:"subir-artefatos",children:"Subir artefatos"}),"\n",(0,n.jsx)(a.p,{children:"Voc\xea pode:"}),"\n",(0,n.jsxs)(a.ul,{children:["\n",(0,n.jsx)(a.li,{children:"selecionar um ou v\xe1rios arquivos para serem agrupados como um artefato."}),"\n",(0,n.jsx)(a.li,{children:"usar curingas (wildcards), v\xe1rios caminhos (paths) e padr\xf5es (patterns) de exclus\xe3o com a sintaxe de sempre do GitHub Actions."}),"\n",(0,n.jsx)(a.li,{children:"definir um per\xedodo de reten\xe7\xe3o para o artefato."}),"\n"]}),"\n",(0,n.jsx)(a.pre,{children:(0,n.jsx)(a.code,{className:"language-yaml",metastring:'title="/.github/workflows/handle-artefacts.yaml"',children:"jobs:\n  upload:\n    runs-on: ubuntu-latest\n    steps:\n      - name: Checkout\n        uses: actions/checkout@v4\n      - name: Fazer upload de logs\n        uses: actions/upload-artifact@v4\n        with:\n          name: todos-os-logs       # nome do artefato\n          path: |                   # caminho dos arquivos inclu\xeddos no artefato\n            **/log*.txt             # caminhos relativos t\xeam como base o $GITHUB_WORKSPACE\n          retention-days: 1\n          if-no-files-found: error  # for\xe7ar etapa a falhar se o conte\xfado a ser inclu\xeddo no artefato n\xe3o for encontrado\n"})}),"\n",(0,n.jsxs)(a.p,{children:["Observe que o per\xedodo m\xe1ximo de reten\xe7\xe3o ",(0,n.jsx)(a.a,{href:"https://docs.github.com/en/actions/learn-github-actions/usage-limits-billing-and-administration#artifact-and-log-retention-policy",children:"pode ser definido em n\xedvel de reposit\xf3rio, organiza\xe7\xe3o ou empresa"}),". H\xe1 um m\xe1ximo de 90 dias para reposit\xf3rios p\xfablicos e de 400 dias para reposit\xf3rios privados. Se voc\xea diminuir o per\xedodo de reten\xe7\xe3o, ter\xe1 mais espa\xe7o de gra\xe7a ;)"]}),"\n",(0,n.jsx)(a.h3,{id:"baixar-artefatos",children:"Baixar artefatos"}),"\n",(0,n.jsx)(a.p,{children:"Para recuperar o artefato, voc\xea pode usar:"}),"\n",(0,n.jsxs)(a.ul,{children:["\n",(0,n.jsxs)(a.li,{children:["a ",(0,n.jsx)(a.a,{href:"https://docs.github.com/en/actions/managing-workflow-runs/downloading-workflow-artifacts",children:"UI do GitHub"})]}),"\n",(0,n.jsxs)(a.li,{children:["a ",(0,n.jsx)(a.a,{href:"https://docs.github.com/en/rest/actions/artifacts?apiVersion=2022-11-28#download-an-artifact",children:"API do GitHub"})]}),"\n",(0,n.jsxs)(a.li,{children:["o ",(0,n.jsxs)(a.a,{href:"https://docs.github.com/en/actions/managing-workflow-runs/downloading-workflow-artifacts?tool=cli",children:[(0,n.jsx)(a.code,{children:"gh"})," cli"]})]}),"\n",(0,n.jsxs)(a.li,{children:["a a\xe7\xe3o oficial ",(0,n.jsx)(a.a,{href:"https://github.com/marketplace/actions/download-a-build-artifact",children:(0,n.jsx)(a.code,{children:"actions/download-artifact"})}),", se precisar recuperar artefatos de maneira program\xe1tica. A partir da ",(0,n.jsx)(a.code,{children:"v4"}),", a a\xe7\xe3o permite baixar artefatos de diferentes fluxos de trabalho ou reposit\xf3rios, desde que voc\xea forne\xe7a um token. (\ud83d\udee1\ufe0f: \xe9 recomendado usar um aplicativo GitHub em vez de um PAT em projetos profissionais.)"]}),"\n"]}),"\n",(0,n.jsxs)(a.p,{children:["Vamos ver como recuperar o artefato que criamos no exemplo anterior usando ",(0,n.jsx)(a.code,{children:"actions/download-artifact"}),":"]}),"\n",(0,n.jsx)(a.pre,{children:(0,n.jsx)(a.code,{className:"language-yaml",metastring:'title="/.github/workflows/handle-artefacts.yaml"',children:'download:\n    runs-on: ubuntu-latest\n    needs: upload\n    steps:\n      - name: Baixar artefatos\n        id: baixar-artefatos\n        uses: actions/download-artifact@v4\n        with:\n          name: todos-os-logs  # \xe9 o nome definido na etapa de upload\n        \n      - name: Usar o artefato em um c\xf3digo python\n        shell: python\n        run: |\n          import os\n          from glob import glob\n          caminho_artefato = os.environ.get("CAMINHO", "")\n          glob_list = glob(caminho_artefato + "/*.txt")\n          for nome_arquivo in glob_list:\n              with open(nome_arquivo, "r", encoding="UTF-8") as f:\n                  conteudo = f.read()\n                  print(conteudo)\n        env:\n          CAMINHO: ${{ steps.baixar-artefatos.outputs.download-path }}\n'})}),"\n",(0,n.jsx)(a.p,{children:"As a\xe7\xf5es de upload e download gerenciam o zip e o unzip dos artefatos automaticamente."}),"\n",(0,n.jsx)(a.h3,{id:"apagar-artefatos",children:"Apagar artefatos"}),"\n",(0,n.jsx)(a.p,{children:"Para excluir um artefato, voc\xea pode:"}),"\n",(0,n.jsxs)(a.ul,{children:["\n",(0,n.jsxs)(a.li,{children:["usar a ",(0,n.jsx)(a.a,{href:"https://docs.github.com/en/actions/managing-workflow-runs/removing-workflow-artifacts",children:"UI do GitHub"})]}),"\n",(0,n.jsxs)(a.li,{children:["usar a ",(0,n.jsx)(a.a,{href:"https://docs.github.com/en/rest/reference/actions#delete-an-artifact",children:"API do GitHub"})]}),"\n",(0,n.jsxs)(a.li,{children:["escrever um ",(0,n.jsx)(a.a,{href:"https://gist.github.com/qwe321qwe321qwe321/efae4569576006624c34f23b2dd76a58",children:"script personalizado usando a API do Github"})," ou usar uma ",(0,n.jsx)(a.a,{href:"https://github.com/GeekyEggo/delete-artifact",children:"a\xe7\xe3o criada pela comunidade"}),"."]}),"\n"]}),"\n",(0,n.jsx)(a.h2,{id:"como-usar-cache",children:"Como usar cache"}),"\n",(0,n.jsx)(a.admonition,{title:"\ud83d\udc09 Aviso de seguran\xe7a",type:"danger",children:(0,n.jsx)(a.p,{children:"N\xe3o armazene informa\xe7\xf5es confidenciais no cache (cuidado com arquivos de configura\xe7\xe3o contendo senhas!), pois o cache \xe9 acess\xedvel a qualquer pessoa com direito de criar um PR no reposit\xf3rio - isso inclui forks!"})}),"\n",(0,n.jsx)(a.p,{children:"Este post j\xe1 est\xe1 grande demais. Vou tentar ser mais objetiva ao explicar cache:"}),"\n",(0,n.jsxs)(a.ul,{children:["\n",(0,n.jsxs)(a.li,{children:["\n",(0,n.jsx)(a.p,{children:"Se voc\xea estiver usando executores auto-hospedados (self-hosted runners), a op\xe7\xe3o de armazenar o cache na sua pr\xf3pria infra s\xf3 est\xe1 dispon\xedvel nos planos Enterprise."}),"\n"]}),"\n",(0,n.jsxs)(a.li,{children:["\n",(0,n.jsxs)(a.p,{children:["A a\xe7\xe3o de cache requer um ",(0,n.jsx)(a.code,{children:"path"})," para o cache e uma ",(0,n.jsx)(a.code,{children:"key"}),". A ",(0,n.jsx)(a.code,{children:"key"})," \xe9 usada para recuperar o cache e recri\xe1-lo numa pr\xf3xima vez."]}),"\n"]}),"\n",(0,n.jsxs)(a.li,{children:["\n",(0,n.jsx)(a.p,{children:"Quando o trabalho termina, a a\xe7\xe3o injeta automaticamente uma etapa p\xf3s-cache que atualiza o cache caso novas depend\xeancias sejam instaladas."}),"\n"]}),"\n",(0,n.jsxs)(a.li,{children:["\n",(0,n.jsx)(a.p,{children:"Esta a\xe7\xe3o gerencia o cache de forma central. Isso significa que o cache fica dispon\xedvel (e atualiz\xe1vel) a todos os trabalhos no mesmo reposit\xf3rio, e tamb\xe9m a outros fluxos de trabalho."}),"\n"]}),"\n",(0,n.jsxs)(a.li,{children:["\n",(0,n.jsxs)(a.p,{children:["Leia mais sobre ",(0,n.jsx)(a.a,{href:"https://github.com/actions/cache/blob/main/caching-strategies.md",children:"estrat\xe9gias de cache aqui"})," (em ingl\xeas)."]}),"\n"]}),"\n"]}),"\n",(0,n.jsx)(a.pre,{children:(0,n.jsx)(a.code,{className:"language-yaml",metastring:'title="/.github/workflows/cache.yaml"',children:"jobs:\n  cache:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-python@v5\n        with:\n          python-version: '3.12'\n          cache: 'pip'\n          cache-dependency-path: |\n            **/requirements.txt\n      \n      - name: Obter diret\xf3rio de cache do  pip\n        id: pip-cache\n        run: |\n          echo \"dir=$(pip cache dir)\" >> $GITHUB_OUTPUT\n\n      - name: Controlar cache para depend\xeancias do python\n        uses: actions/cache@v3\n        id: cache\n        with:\n          path: ${{ steps.pip-cache.outputs.dir }}\n          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}\n        \n      - name: Instalar depend\xeancias quando cache n\xe3o for id\xeantico\n        if: steps.cache.outputs.cache-hit != 'true'\n        run: pip install -r requirements.txt\n"})}),"\n",(0,n.jsx)(a.p,{children:"Se quiser ver a prova do crime, veja os logs salvos (em ingl\xeas):"}),"\n",(0,n.jsxs)(a.ul,{children:["\n",(0,n.jsxs)(a.li,{children:[(0,n.jsx)(a.a,{href:"https://raw.githubusercontent.com/magmanu/blog/main/demos/github-actions-data-flow/31_data_flow_cache_set-cache.txt",children:"logs da defini\xe7\xe3o do cache"}),": primeira execu\xe7\xe3o, n\xe3o h\xe1 cache, ent\xe3o o cache \xe9 definido"]}),"\n",(0,n.jsxs)(a.li,{children:[(0,n.jsx)(a.a,{href:"https://raw.githubusercontent.com/magmanu/blog/main/demos/github-actions-data-flow/32_data_flow_cache_use-cache.txt",children:"logs do uso do cache"}),": na segunda execu\xe7\xe3o, o cache \xe9 encontrado e usado"]}),"\n",(0,n.jsxs)(a.li,{children:[(0,n.jsx)(a.a,{href:"https://raw.githubusercontent.com/magmanu/blog/main/demos/github-actions-data-flow/33_data_flow_cache_update-cache.txt",children:"logs de atualiza\xe7\xe3o do cache"}),": o arquivo requirements.txt foi alterado, ent\xe3o o cache n\xe3o coincide. As depend\xeancias s\xe3o reinstaladas e o cache \xe9 atualizado."]}),"\n"]}),"\n",(0,n.jsxs)(a.p,{children:["Curiosidade: voc\xea notou a fun\xe7\xe3o ",(0,n.jsx)(a.code,{children:"hashFiles"})," usada na etapa acima?",(0,n.jsx)(a.br,{}),"\n","\xc9 uma fun\xe7\xe3o fornecida pelo GitHub Actions para criar um valor hash exclusivo ligado a um arquivo. Quando o valor do hash n\xe3o coincide, significa que as depend\xeancias foram alteradas, o que invalida o cache. Assim, as depend\xeancias s\xe3o instaladas e o cache \xe9 atualizado em uma tarefa p\xf3s-cache."]}),"\n",(0,n.jsx)(a.p,{children:"At\xe9 mais! :)"}),"\n",(0,n.jsx)(a.h2,{id:"using-cache",children:"Using cache"}),"\n",(0,n.jsx)(a.admonition,{title:"\ud83d\udc09 Security warning",type:"danger",children:(0,n.jsx)(a.p,{children:"Do not store sensitive information in the cache (beware of configuration files containing secrets), as the cache is accessible to anyone who can create a PR on the repository, even on forks."})}),"\n",(0,n.jsx)(a.p,{children:"Quando lidamos com dados est\xe1veis que s\xe3o\u200b\u200b usados \u200b\u200brepetidamente (por exemplo, depend\xeancias), podemos usar cache para melhorar o desempenho da pipeline."}),"\n",(0,n.jsxs)(a.p,{children:["No exemplo abaixo, vamos armazenar em cache as depend\xeancias ",(0,n.jsx)(a.code,{children:"pip"}),". Repare que a etapa de cache foi colocada antes da etapa de instala\xe7\xe3o das depend\xeancias: a ideia \xe9 que a instala\xe7\xe3o s\xf3 aconte\xe7a se o cache estiver desatualizado ou inexistente."]}),"\n",(0,n.jsx)(a.pre,{children:(0,n.jsx)(a.code,{className:"language-yaml",metastring:'title="/.github/workflows/cache.yaml"',children:"jobs:\n  cache:\n    runs-on: ubuntu-latest\n    steps:\n      - uses: actions/checkout@v4\n      - uses: actions/setup-python@v5\n        with:\n          python-version: '3.12'\n          cache: 'pip'\n          cache-dependency-path: |\n            **/requirements.txt\n      \n      - name: Obter diret\xf3rio de cache do  pip\n        id: pip-cache\n        run: |\n          echo \"dir=$(pip cache dir)\" >> $GITHUB_OUTPUT\n\n      - name: Controlar cache para depend\xeancias do python\n        uses: actions/cache@v3\n        id: cache\n        with:\n          # path: localiza\xe7\xe3o dos arquivos a serem armazenados em cache\n          path: ${{ steps.pip-cache.outputs.dir }}\n          # key: id \xfanico usado para recuperar e recriar o cache\n          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}\n        \n      - name: Instalar depend\xeancias quando cache n\xe3o for id\xeantico\n        if: steps.cache.outputs.cache-hit != 'true'\n        run: pip install -r requirements.txt\n"})}),"\n",(0,n.jsx)(a.h3,{id:"configurando-o-cache",children:"Configurando o cache"}),"\n",(0,n.jsxs)(a.p,{children:["Na primeira vez que o fluxo de trabalho \xe9 executado, obviamente o cache est\xe1 vazio. Por isso, o output ",(0,n.jsx)(a.code,{children:"cache-hit"})," (nativo da a\xe7\xe3o oficial ",(0,n.jsx)(a.code,{children:"actions/cache"}),") retornar\xe1 ",(0,n.jsx)(a.code,{children:"false"}),". Assim, o fluxo de trabalho vai executar a etapa de instala\xe7\xe3o.",(0,n.jsx)(a.br,{}),"\n",(0,n.jsx)(a.a,{href:"https://raw.githubusercontent.com/magmanu/blog/main/demos/github-actions-data-flow/31_data_flow_cache_set-cache.txt",children:(0,n.jsx)(a.em,{children:"Confere nos logs!"})})," (em ingl\xeas)"]}),"\n",(0,n.jsxs)(a.p,{children:["Maaaas... Uma pequena m\xe1gica tamb\xe9m acontece: uma etapa p\xf3s-cache, adicionada automaticamente pela a\xe7\xe3o ",(0,n.jsx)(a.code,{children:"action/cache"})," no final da execu\xe7\xe3o do trabalho, confere as chaves e adiciona os arquivos ao cache."]}),"\n",(0,n.jsx)(a.h3,{id:"recuperando-o-cache",children:"Recuperando o cache"}),"\n",(0,n.jsxs)(a.p,{children:["Desde que nada tenha mudado no manifesto das depend\xeancias (requirements.txt), quando ",(0,n.jsx)(a.code,{children:"actions/cache"})," for executado de novo com o mesmo caminho e a mesma chave, a a\xe7\xe3o vai encontrar um ",(0,n.jsx)(a.code,{children:"cache-hit"})," e o fluxo de trabalho vai pular a etapa de instala\xe7\xe3o.",(0,n.jsx)(a.br,{}),"\n",(0,n.jsx)(a.a,{href:"https://raw.githubusercontent.com/magmanu/blog/main/demos/github-actions-data-flow/32_data_flow_cache_use-cache.txt",children:(0,n.jsx)(a.em,{children:"Confere nos logs!"})})," (em ingl\xeas)"]}),"\n",(0,n.jsx)(a.h3,{id:"atualizando-o-cache",children:"Atualizando o cache"}),"\n",(0,n.jsxs)(a.p,{children:["Voc\xea reparou na fun\xe7\xe3o ",(0,n.jsx)(a.code,{children:"hashFiles"})," usada no argumento ",(0,n.jsx)(a.code,{children:"key"}),"?",(0,n.jsx)(a.br,{}),"\n","Esta \xe9 uma fun\xe7\xe3o nativa do GitHub Actions que cria uma hash exclusiva baseada no caminho de um arquivo. Quando o valor da hash n\xe3o d\xe1 match, significa que o arquivo foi alterado \u2013 no nosso caso, isso pode indicar que alguma depend\xeancia foi adicionada/removida/atualizada."]}),"\n",(0,n.jsxs)(a.p,{children:["Assim, o cache fica in\xfatil, e o output ",(0,n.jsx)(a.code,{children:"cache-hit"})," vai induzir a execu\xe7\xe3o de ",(0,n.jsx)(a.code,{children:"pip install"}),". Voltamos ent\xe3o \xe0 \xe0 estaca zero: as depend\xeancias s\xe3o instaladas mais uma vez e o cache \xe9 atualizado.",(0,n.jsx)(a.br,{}),"\n",(0,n.jsx)(a.a,{href:"https://raw.githubusercontent.com/magmanu/blog/main/demos/github-actions-data-flow/33_data_flow_cache_update-cache.txt",children:(0,n.jsx)(a.em,{children:"Confere nos logs!"})})," (em ingl\xeas)"]}),"\n",(0,n.jsx)(a.h3,{id:"coment\xe1rios-finais-sobre-caches",children:"Coment\xe1rios finais sobre caches"}),"\n",(0,n.jsxs)(a.ul,{children:["\n",(0,n.jsx)(a.li,{children:"A op\xe7\xe3o de auto-armazenar o cache em executores auto-hospedados s\xf3 est\xe1 dispon\xedvel nos planos Enterprise."}),"\n",(0,n.jsxs)(a.li,{children:["A a\xe7\xe3o ",(0,n.jsx)(a.code,{children:"actions/cache"})," gerencia o cache de forma centralizada. Isso significa que o cache fica dispon\xedvel e atualiz\xe1vel para todos os trabalhos no mesmo repo - e at\xe9 mesmo para outros fluxos de trabalho."]}),"\n",(0,n.jsxs)(a.li,{children:["Leia mais sobre ",(0,n.jsx)(a.a,{href:"https://github.com/actions/cache/blob/main/caching-strategies.md",children:"estrat\xe9gias de cache aqui"})," (em ingl\xeas)."]}),"\n"]}),"\n",(0,n.jsx)(a.p,{children:"Eita que post grande, socorro."})]})}function u(e={}){const{wrapper:a}={...(0,s.R)(),...e.components};return a?(0,n.jsx)(a,{...e,children:(0,n.jsx)(l,{...e})}):l(e)}},8453:(e,a,o)=>{o.d(a,{R:()=>t,x:()=>r});var n=o(6540);const s={},i=n.createContext(s);function t(e){const a=n.useContext(i);return n.useMemo((function(){return"function"==typeof e?e(a):{...a,...e}}),[a,e])}function r(e){let a;return a=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),n.createElement(i.Provider,{value:a},e.children)}}}]);