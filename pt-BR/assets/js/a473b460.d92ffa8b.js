"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[86],{5845:(e,o,a)=>{a.r(o),a.d(o,{assets:()=>c,contentTitle:()=>t,default:()=>l,frontMatter:()=>n,metadata:()=>s,toc:()=>d});var i=a(4848),r=a(8453);const n={slug:"migrate-codecommit-to-github",title:"Como Migrar do CodeCommit para o GitHub \u2014 Mantendo sua pipeline Amplify",authors:"manu",tags:["infra","github","amplify","aws","ci/cd","tutorial"]},t=void 0,s={permalink:"/blog/pt-BR/tech/migrate-codecommit-to-github",source:"@site/i18n/pt-BR/docusaurus-plugin-content-blog-tech/2021-10-13-migrate-codecommit-to-github/index.md",title:"Como Migrar do CodeCommit para o GitHub \u2014 Mantendo sua pipeline Amplify",description:"Este tutorial inclui orienta\xe7\xf5es para tr\xeas cen\xe1rios de administra\xe7\xe3o no GitHub:",date:"2021-10-13T00:00:00.000Z",tags:[{label:"infra",permalink:"/blog/pt-BR/tech/tags/infra"},{label:"github",permalink:"/blog/pt-BR/tech/tags/github"},{label:"amplify",permalink:"/blog/pt-BR/tech/tags/amplify"},{label:"aws",permalink:"/blog/pt-BR/tech/tags/aws"},{label:"ci/cd",permalink:"/blog/pt-BR/tech/tags/ci-cd"},{label:"tutorial",permalink:"/blog/pt-BR/tech/tags/tutorial"}],readingTime:4.9,hasTruncateMarker:!0,authors:[{name:"Manu Magalh\xe3es",title:"Engenheira de DevSecOps",url:"https://github.com/magmanu",imageURL:"https://github.com/magmanu.png",key:"manu"}],frontMatter:{slug:"migrate-codecommit-to-github",title:"Como Migrar do CodeCommit para o GitHub \u2014 Mantendo sua pipeline Amplify",authors:"manu",tags:["infra","github","amplify","aws","ci/cd","tutorial"]},unlisted:!1,prevItem:{title:"Solu\xe7\xe3o: Terraform n\xe3o deixa tern\xe1rios terem tipos diferentes",permalink:"/blog/pt-BR/tech/terraform-ternary-error"}},c={authorsImageUrls:[void 0]},d=[{value:"Migrando o Repo",id:"migrando-o-repo",level:2},{value:"Confirme",id:"confirme",level:3},{value:"Arrume",id:"arrume",level:3},{value:"Redirecionando a pipeline do Amplify",id:"redirecionando-a-pipeline-do-amplify",level:2},{value:"Execute o comando <code>update-app</code>",id:"execute-o-comando-update-app",level:3},{value:"Reautentique o app Amplify",id:"reautentique-o-app-amplify",level:3},{value:"A Abordagem via Webhook",id:"a-abordagem-via-webhook",level:3},{value:"Limita\xe7\xf5es do webhook",id:"limita\xe7\xf5es-do-webhook",level:3}];function p(e){const o={a:"a",admonition:"admonition",br:"br",code:"code",em:"em",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(o.p,{children:"Este tutorial inclui orienta\xe7\xf5es para tr\xeas cen\xe1rios de administra\xe7\xe3o no GitHub:"}),"\n",(0,i.jsxs)(o.ol,{children:["\n",(0,i.jsx)(o.li,{children:"Quando o repo est\xe1 na sua conta pessoal;"}),"\n",(0,i.jsx)(o.li,{children:"Quando o repo est\xe1 dentro de uma organiza\xe7\xe3o no GitHub e a galera da administra\xe7\xe3o te d\xe1 as permiss\xf5es necess\xe1rias; e"}),"\n",(0,i.jsx)(o.li,{children:"Quando o repo est\xe1 dentro de uma organiza\xe7\xe3o no GitHub e a galera da administra\xe7\xe3o N\xc3O te d\xe1 as permiss\xf5es necess\xe1rias."}),"\n"]}),"\n",(0,i.jsx)(o.p,{children:(0,i.jsx)(o.em,{children:"Pr\xe9-requisitos: Acesso e permiss\xf5es relevantes para CodeCommit e Amplify. Voc\xea tamb\xe9m precisa de uma conta ativa no GitHub."})}),"\n",(0,i.jsx)(o.h2,{id:"migrando-o-repo",children:"Migrando o Repo"}),"\n",(0,i.jsxs)(o.ol,{children:["\n",(0,i.jsx)(o.li,{children:"Abra o terminal e fa\xe7a cd para a pasta onde est\xe1 o repo do CodeCommit."}),"\n",(0,i.jsxs)(o.li,{children:["Execute ",(0,i.jsx)(o.code,{children:"git remote get-url origin"})," para obter o URL para clonar o projeto a ser migrado para o GitHub."]}),"\n",(0,i.jsxs)(o.li,{children:["Crie uma pasta tempor\xe1ria executando ",(0,i.jsx)(o.code,{children:"mkdir ../temp-clone"})," e abra-a na CLI executando ",(0,i.jsx)(o.code,{children:"cd ../temp-clone"}),"."]}),"\n",(0,i.jsxs)(o.li,{children:["Execute ",(0,i.jsx)(o.code,{children:"git clone --bare"})," seguido do URL que voc\xea pegou na etapa 2. Um exemplo seria ",(0,i.jsx)(o.code,{children:"git clone --bare <https://git-codecommit.eu-west-1.amazonaws.com/v1/repos/nome-do-diretorio-do-codecommit>"}),"."]}),"\n"]}),"\n",(0,i.jsx)("br",{}),"\n",(0,i.jsx)(o.admonition,{title:"Nota Educativa",type:"note",children:(0,i.jsxs)(o.p,{children:["O sufixo (flag) ",(0,i.jsx)(o.code,{children:"--bare"})," \xe9 uma forma de clonar o repo cortando todos os v\xednculos com o remoto (CodeCommit, neste caso). Voc\xea ainda vai ter todos os branches, tags e tal, mas o repo clonado fica completamente independente do remoto."]})}),"\n",(0,i.jsx)("br",{}),"\n",(0,i.jsxs)(o.ol,{start:"5",children:["\n",(0,i.jsx)(o.li,{children:"Crie um novo repo no GitHub. Para evitar problemas, n\xe3o adicione nenhum README, .gitignore nem nada. Depois de clicar em \u201cCreate repo\u201d (Criar repo), a \xfanica coisa a fazer \xe9 copiar o URL como mostrado abaixo. N\xe3o execute nenhum git init, n\xe3o fa\xe7a um commit inicial, nada. S\xf3 copia o link."}),"\n"]}),"\n",(0,i.jsx)("br",{}),"\n",(0,i.jsx)(o.p,{children:(0,i.jsx)(o.img,{alt:"Git clone SSH",src:a(1702).A+"",width:"1400",height:"508"})}),"\n",(0,i.jsx)("br",{}),"\n",(0,i.jsxs)(o.ol,{start:"6",children:["\n",(0,i.jsxs)(o.li,{children:["Voltando ao terminal, execute ",(0,i.jsx)(o.code,{children:"cd nome-do-diretorio-do-codecommit.git"}),", e depois fa\xe7a um push mirror seguido pelo URL que voc\xea obteve na etapa 5. No exemplo acima, o comando seria ",(0,i.jsx)(o.code,{children:"git push --mirror <https://github.com/my-username/my-project.git>"}),"."]}),"\n"]}),"\n",(0,i.jsx)(o.p,{children:"\xc9 isso, a migra\xe7\xe3o acabou."}),"\n",(0,i.jsx)(o.h3,{id:"confirme",children:"Confirme"}),"\n",(0,i.jsxs)(o.p,{children:["Para confirmar que deu tudo certo, volte ao GitHub e atualize a p\xe1gina. O repo vai estar todo bonitinho l\xe1, com hist\xf3rico de commits, as branches e o resto todo.",(0,i.jsx)(o.br,{}),"\n","Para usar repo migrado para o GitHub, \xe9 s\xf3 fazer o clone de sempre e seguir com a vida :)"]}),"\n",(0,i.jsx)(o.h3,{id:"arrume",children:"Arrume"}),"\n",(0,i.jsxs)(o.p,{children:["Se voc\xea seguiu as instru\xe7\xf5es, agora \xe9 hora de excluir sua pasta tempor\xe1ria. Volte para o terminal e execute ",(0,i.jsx)(o.code,{children:"cd ../.."})," e ",(0,i.jsx)(o.code,{children:"rm -rf temp-clone"}),". Se voc\xea usou a pasta tmp do sistema operacional, pode pular essa etapa."]}),"\n",(0,i.jsx)(o.h2,{id:"redirecionando-a-pipeline-do-amplify",children:"Redirecionando a pipeline do Amplify"}),"\n",(0,i.jsx)(o.p,{children:"Agora que voc\xea migrou o c\xf3digo para o GitHub, como voc\xea mant\xe9m a pipeline Amplify que estava ligada ao repo no CodeCommit?"}),"\n",(0,i.jsxs)(o.h3,{id:"execute-o-comando-update-app",children:["Execute o comando ",(0,i.jsx)(o.code,{children:"update-app"})]}),"\n",(0,i.jsx)(o.pre,{children:(0,i.jsx)(o.code,{className:"language-bash",children:"AWS_PROFILE=PERFIL AWS_DEFAULT_REGION=REGI\xc3O aws amplify update-app --app-id AMPLIFY_APP_ID --repository REPOSITORY_URL --access-token ACCESS_TOKEN\n"})}),"\n",(0,i.jsxs)(o.p,{children:[(0,i.jsx)(o.code,{children:"AMPLIFY_APP_ID"}),": para encontrar a ID da sua aplica\xe7\xe3o, acesse o console do Amplify. Em App settings (Configura\xe7\xf5es do aplicativo), clique em General (Geral) e procure o ARN da aplica\xe7\xe3o. A ID da aplica\xe7\xe3o \xe9 a sequ\xeancia alfanum\xe9rica no final do ARN. A ID \xe9 mostrada como REDACTED na imagem abaixo:"]}),"\n",(0,i.jsx)("br",{}),"\n",(0,i.jsx)(o.p,{children:(0,i.jsx)(o.img,{alt:"Amplify App Id",src:a(9951).A+"",width:"1400",height:"459"})}),"\n",(0,i.jsx)("br",{}),"\n",(0,i.jsxs)(o.p,{children:[(0,i.jsx)(o.code,{children:"REPOSITORY_URL"}),": \xc9 o URL que voc\xea usou na etapa 5 da migra\xe7\xe3o.",(0,i.jsx)(o.br,{}),"\n",(0,i.jsx)(o.code,{children:"ACCESS_TOKEN"}),": o token de acesso \xe9 um token que voc\xea pode gerar no GitHub. Pode ser o PAT (token de acesso pessoal) de quem administra o repo, mas se for um projeto profissional, prefira usar um ",(0,i.jsx)(o.a,{href:"https://docs.github.com/pt/apps/creating-github-apps/authenticating-with-a-github-app/generating-a-user-access-token-for-a-github-app",children:"token de acesso do usu\xe1rio gerado por um app no GitHub"}),"."]}),"\n",(0,i.jsx)(o.h3,{id:"reautentique-o-app-amplify",children:"Reautentique o app Amplify"}),"\n",(0,i.jsx)(o.admonition,{title:"XP da vida real",type:"tip",children:(0,i.jsxs)(o.p,{children:["As empresas podem restringir bastante quais apps s\xe3o aprovados no GitHub. Se por algum motivo o app Amplify n\xe3o for aprovado, pule para a se\xe7\xe3o ",(0,i.jsx)(o.a,{href:"#a-abordagem-via-webhook",children:'"A abordagem via Webhook"'}),"."]})}),"\n",(0,i.jsx)(o.p,{children:"Agora voc\xea pode reconectar sua aplica\xe7\xe3o. Na mesma p\xe1gina em que obteve o ARN, acima do ARN tem o bot\xe3o \u201cReconnect repository\u201d (Reconectar reposit\xf3rio). Ao clicar nele, a p\xe1gina de aprova\xe7\xe3o no GitHub \xe9 aberta."}),"\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsxs)(o.li,{children:[(0,i.jsx)(o.strong,{children:"Se o reposit\xf3rio migrado N\xc3O estiver em uma Organiza\xe7\xe3o"}),", clique no bot\xe3o \u201cAuthorize aws-amplify-console\u201d (Autorizar aws-amplify-console). O console do Amplify vai abrir, e l\xe1 voc\xea pode selecionar o repo. Pronto, fim."]}),"\n",(0,i.jsxs)(o.li,{children:[(0,i.jsx)(o.strong,{children:"Se o reposit\xf3rio migrado estiver em uma Organiza\xe7\xe3o"}),", clique no bot\xe3o para solicitar a permiss\xe3o OAuth para o app Amplify. Uma mensagem de solicita\xe7\xe3o pendente fica dispon\xedvel at\xe9 que a administra\xe7\xe3o a aprove (voc\xea vai receber um e-mail quando isso acontecer)."]}),"\n"]}),"\n",(0,i.jsx)("br",{}),"\n",(0,i.jsx)(o.p,{children:(0,i.jsx)(o.img,{alt:"Authorize Amplify Github App",src:a(2706).A+"",width:"1186",height:"1206"})}),"\n",(0,i.jsx)("br",{}),"\n",(0,i.jsx)(o.p,{children:"Depois da aprova\xe7\xe3o, volte para o app Amplify e clique em \u201cReconnect repository\u201d (Reconectar reposit\xf3rio) novamente. Os repos da sua organiza\xe7\xe3o e da sua pr\xf3pria conta aparecem, para voc\xea escolher um deles. Fim."}),"\n",(0,i.jsx)(o.h3,{id:"a-abordagem-via-webhook",children:"A Abordagem via Webhook"}),"\n",(0,i.jsx)(o.p,{children:"Se voc\xea n\xe3o puder usar o app Amplify no GitHub, voc\xea pode usar um webhook. Para isso, em App settings (Configura\xe7\xf5es do aplicativo), clique em General (Geral), selecione Build Settings (Configura\xe7\xf5es de compila\xe7\xe3o) e clique em Create Webhook (Criar Webhook),  ambos mostrados em laranja abaixo."}),"\n",(0,i.jsx)("br",{}),"\n",(0,i.jsx)(o.p,{children:(0,i.jsx)(o.img,{alt:"Amplify Build Settings",src:a(3187).A+"",width:"1181",height:"295"})}),"\n",(0,i.jsx)("br",{}),"\n",(0,i.jsx)(o.p,{children:"No pop-up, digite um nome e selecione um branch para fazer o build. O novo webhook ser\xe1 exibido na interface do Amplify. Copie o URL porque vamos precisar dele no GitHub."}),"\n",(0,i.jsx)("br",{}),"\n",(0,i.jsx)(o.p,{children:(0,i.jsx)(o.img,{alt:"Amplify Incming Webhooks",src:a(5666).A+"",width:"769",height:"234"})}),"\n",(0,i.jsx)("br",{}),"\n",(0,i.jsx)(o.p,{children:"Agora volte para o repo no GitHub, selecione Configura\xe7\xf5es > Webhooks e clique no bot\xe3o Add webhook (Adicionar webhook)."}),"\n",(0,i.jsx)("br",{}),"\n",(0,i.jsx)(o.p,{children:(0,i.jsx)(o.img,{alt:"Adding GitHub Webhooks",src:a(8416).A+"",width:"1264",height:"868"})}),"\n",(0,i.jsx)(o.p,{children:"Acabou, finalmente."}),"\n",(0,i.jsx)(o.h3,{id:"limita\xe7\xf5es-do-webhook",children:"Limita\xe7\xf5es do webhook"}),"\n",(0,i.jsx)(o.p,{children:"Se voc\xea usar o webhook, lembre-se de que:"}),"\n",(0,i.jsxs)(o.ul,{children:["\n",(0,i.jsx)(o.li,{children:"Se precisar conectar v\xe1rios branches ao Amplify, voc\xea vai precisar de um webhook no Amplify para cada branch, e vai precisar adicionar cada webhook ao GitHub, um por um. Se bater a tenta\xe7\xe3o de fazer um script, converse com a galera que faz admin do Github na sua empresa e tenta aprovar o app Amplify. Ningu\xe9m merece viver na gambiarra."}),"\n",(0,i.jsx)(o.li,{children:"Qualquer git push vai espoletar (trigger) o webhook em cada deploy no Amplify. Em outras palavras, se voc\xea tiver as branches \u201cmain\u201d, \u201crelease\u201d, \u201cdev\u201d, \u201cfeature/a\u201d e \u201cfeature/b\u201d, toda vez que algu\xe9m fizer um push em \u201cdev\u201d, a pipeline vai espoletar em todas as cinco branches."}),"\n"]}),"\n",(0,i.jsx)(o.p,{children:"Espero ter sido \xfatil, at\xe9 mais!"})]})}function l(e={}){const{wrapper:o}={...(0,r.R)(),...e.components};return o?(0,i.jsx)(o,{...e,children:(0,i.jsx)(p,{...e})}):p(e)}},3187:(e,o,a)=>{a.d(o,{A:()=>i});const i=a.p+"assets/images/amplify_build_settings-937fb3f3220996941f487bd5ed440afe.webp"},9951:(e,o,a)=>{a.d(o,{A:()=>i});const i=a.p+"assets/images/amplify_data-ed02eb0516b95e7d3782a0b619920733.webp"},5666:(e,o,a)=>{a.d(o,{A:()=>i});const i=a.p+"assets/images/amplify_incoming_webhooks-e4c6bd369f275c88df521b33d531b072.webp"},2706:(e,o,a)=>{a.d(o,{A:()=>i});const i=a.p+"assets/images/authorize_amplify_app-0c09d0e0746dd8ee0e5bf2f70539c74a.webp"},1702:(e,o,a)=>{a.d(o,{A:()=>i});const i=a.p+"assets/images/clone_ssh-5be730cf4d2ec7e3548855fc55af9e16.webp"},8416:(e,o,a)=>{a.d(o,{A:()=>i});const i=a.p+"assets/images/github_webhooks-143154a73be16465c0004e7d5de274d3.webp"},8453:(e,o,a)=>{a.d(o,{R:()=>t,x:()=>s});var i=a(6540);const r={},n=i.createContext(r);function t(e){const o=i.useContext(n);return i.useMemo((function(){return"function"==typeof e?e(o):{...o,...e}}),[o,e])}function s(e){let o;return o=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:t(e.components),i.createElement(n.Provider,{value:o},e.children)}}}]);